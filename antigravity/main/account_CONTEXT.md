# Account & Terms 開発コンテキスト

本ドキュメントは、マイページ機能 (`account.html`) および 利用規約ページ (`terms.html`) の開発ガイドラインです。

## 1. マイページ (`account.html`) 機能概要

**基本方針**: ユーザーのエンゲージメントを高めるハブとして機能する。認証状態に応じて表示を切り替え、未ログインユーザーにはログインを促す。

### 1.1 認証状態によるフロー

1.  **ゲスト (Guest View)**

    - **UI**: 「ログインが必要です」というメッセージとログインボタンのみを表示。
    - **目的**: 心理的障壁を下げつつ、機能利用の前提としてのログインを促す。
    - **アクション**: ログインボタン押下で Google ログインを実行 (`triggerLogin`)。

2.  **ログイン済み (Authenticated View)**
    - **プロファイル**: アイコン、名前、メールアドレスを表示。
    - **アコーディオン・セクション (NEW)**:
      - **🌟 お気に入り**: 初期状態で非表示。タイトル横に登録数を表示。
      - **📦 注文履歴**: 初期状態で非表示（ユーザー要望により変更）。タイトル横に注文総数を表示。
    - **注文履歴の詳細**:
      - 直近 10 件を表示。
      - 内容: 店舗名、日時、商品詳細、合計金額、ステータスバッジ。
      - **ステータス遷移**: 各注文カードをクリックすると、その注文の詳細ステータス画面 (`pos/status.html?orderId=...`) へ遷移する。
    - **設定 (Settings)**:
      - **呼び出し通知**: FCM トークンの保存リクエスト。iOS/Mac などの非対応環境では無効化表示。
      - **利用規約リンク**: `terms.html` への遷移。
      - **アカウント削除**: Firestore および Authentication からユーザーを完全削除 (Danger Zone)。

### 1.2 実装詳細要件

- **アコーディオン UI**: 履歴セクションは `max-height` トランジションで開閉。
- **ローディング**: 読み込み中はスケルトンスクリーン (`loading-skeleton`) を表示。
- **ホバーエフェクト**: カード等のインタラクティブ要素に `transform` や `box-shadow` を適用。

## 2. 利用規約ページ (`terms.html`)

- **役割**: サービス利用におけるルールの明示。
- **内容**:
  - **重要事項**: キャンセル不可、受取期限 (15 分)。
  - **BAN 警告**: 違反時はコンピュータ科学部作成サービスからの BAN。
  - **運営情報**: 横浜南陵高校コンピュータ科学部による運営。
  - **免責・禁止事項**: システム的な責任範囲の明記。
- **デザイン**: `style.css` (App Shell) をベースにした統一感のあるデザイン。

## 3. 最新の開発履歴 (2026-01-01 更新)

### 3.1 機能追加

- **ゲスト表示の簡素化 (完了)**: 未ログイン時の情報を隠蔽し、ログイン誘導に特化。
- **利用規約ページの独立 (完了)**: `mobile-order.html` 内の規約コンテンツを独立ページ化し、文言を強化。
- **アカウント削除機能 (完了)**: 物理削除 (`deleteDoc`, `deleteUser`) の実装と再認証フローの考慮。

### 3.2 UI/UX 改善

- **通知設定の堅牢化**: iOS/Mac 判定によるスイッチ無効化、Service Worker 登録待ちによるトークン取得エラーの回避。
- **インタラクション**: 各所へのホバーアニメーション追加。

### 3.3 認証フローの改善 (2026-01-10 更新)

- **認証方式**: `signInWithPopup` を採用 (GitHub Pages 等のクロスドメイン制約回避のため)。
- **アプリ内ブラウザ対策**:
  - LINE/Instagram 等のアプリ内ブラウザで開かれた場合、アラートで警告を表示。
  - 認証処理が 2.5 秒以内に応答しない場合、自動的にタイムアウトして「ログイン画面」を表示 (Blank Page 防止)。
- **動作環境の明記**:
  - Chrome 推奨、iPhone (Safari/Chrome) も動作確認はしたが、原則 Chrome 推奨のスタンス。
  - ログイン不可時の対応として「不具合報告フォーム」へのリンクを設置。
    |

### 3.4 UI 構成の刷新と履歴連携 (2026-01-13 更新)

- **ダッシュボードの廃止**: 以前の 2 カラムグリッド方式のダッシュボードを廃止し、より省スペースで直感的なアコーディオン形式に移行。
- **バッジ機能の実装**: セクションを閉じている状態でも「何件あるか」がわかるよう、ヘッダーに件数バッジを表示。
- **注文履歴からの遷移**: 「注文後にページを離れても、後でステータスを確認したい」というニーズに応え、履歴一覧から直接ステータス画面へ戻れる導線を確保。
- **表示バグの修正**: スケルトン表示（読み込み中）に使用していた固定幅・高さが実データ読み込み後も残る問題を解消。
