# Mobile Order & Status 開発コンテキスト

本ドキュメントは、モバイルオーダー機能 (`mobile-order.html`) および 注文ステータス確認機能 (`status.html`) の開発ガイドラインです。

## 1. モバイルオーダー (`mobile-order.html`) フロー定義

**基本方針**: ユーザーはまず認証を行い、規約に同意した上で店舗・商品を選択する。

### 1.1 順序フロー

1.  **Google ログイン (Login First)**

    - **理由**: Firestore セキュリティルールの観点から、商品データや店舗データへのアクセスには認証が必須であるため。
    - **挙動**: 画面アクセス時、未ログインであれば即座にログイン画面を表示。ログイン完了後に次へ進む。

2.  **通知許可 (FCM)**

    - **目的**: 調理完了時の呼び出し通知用。
    - **挙動**: ブラウザの通知許可ダイアログを表示。
    - **データ**: 許可された場合、FCM トークンを `users/{uid}` に保存。
    - **すでに許可済みの場合**: 通知許可ダイアログを表示しない。

3.  **規約同意 (Terms of Service) [重要]**

    - **表示内容**: 以下の規約を **大きく** 表示し、同意を求める。
      1.  **注文確定後のキャンセル不可**
      2.  **受け取りは呼び出し後 15 分以内**（経過後は即廃棄）
      3.  **違反時のペナルティ**: 料金徴収の上、今後コンピュータ科学部制作サービスからアカウント永久 BAN
    - **挙動**: 「同意する」ボタン押下でのみ進行可能。
    - **注意**: ２回目以降であっても、規約同意画面を表示する。

4.  **店舗選択**

    - カード型リストで店舗を表示。店舗選択でその店舗のメニュー画面へ。

5.  **メニュー画面 (Grid View)**

    - 商品画像をメインにした 2 列グリッド表示。
    - 在庫切れ商品は選択不可かつ「SOLD OUT」バッジ表示。

6.  **商品詳細・カスタマイズ (Item Detail)**

    - **機能**: `pos.html` と同様のカスタマイズ機能を提供。
      - **カスタマイズ**: 「ケチャップ抜き」「ピクルス追加」などの増減（`allowedToppings` に基づく）。
      - **数量変更**: デフォルト 1。
    - **挙動**: 「カートに追加」でグリッド画面に戻る。

7.  **カート (Cart)**

    - 画面下部のカートアイコン/バーからアクセス。
    - **機能**: 数量変更、削除。
    - **アクション**: 「レジへ進む」ボタン押下で最終確認へ進む。

8.  **注文確定 (Checkout)**
    - **表示**: 受け取り店舗名、注文内容（商品、オプション、合計金額）。
    - **アクション**: 「注文を確定する」ボタン押下。
    - **バックエンド処理**:
      1.  Sync Cart: ローカルカートを `users/{uid}/cart` に同期。
      2.  Call Function: `createOnlineOrder` を呼び出し。
    - **完了**: 成功時に `status.html?orderId={...}` へリダイレクト。

---

## 2. 実装詳細要件

### 2.1 データ構造 (Customization)

`pos.html` の仕様に準拠する。

```javascript
// Cart Item Structure
{
  uniqueId: "timestamp_random",
  productId: "item_id",
  name: "商品名",
  price: 100,
  quantity: 1,
  // カスタマイズ配列
  customizations: [
     { mode: "NO", target: "ケチャップ" },
     { mode: "ADD", target: "ピクルス" }
  ]
}
```

### 2.2 デザインシステム

- モダンでクリーンな UI。

---

## 3. 注文ステータス確認 (`status.html`)

- **役割**: 調理状況のリアルタイム確認。
- **機能**:
  - Firestore `onSnapshot` によるリアルタイム更新。
  - ステータス可視化 (Waiting -> Cooking -> Ready -> Completed)。
  - 呼出番号 (Receipt Number) の表示。

---

## 4. 最新の開発履歴 (2025-12-26 更新)

### 4.1 UI/UX の大幅改善

- **商品詳細モーダル**

  - **フルスクリーン化**: `max-width: 480px` に制限した上で、アプリのような全画面遷移エフェクトを実装。
  - **画像読み込み**: Firestore の `imageURL` フィールドを参照し、Firebase Storage から画像を動的に取得するロジック (`setProductImage`) を導入。未設定時やエラー時は `noimage.png` にフォールバック。
  - **カスタマイズ UI**:
    - 初期状態は折りたたまれており、タップで展開。
    - **選択ロジック改善**: モード（抜き/追加）未選択時にトッピングを押すと、アラートではなくモード選択エリアがアニメーション（揺れる）して注意を促す仕様に変更。
    - **視認性向上**: 「抜き」選択中は赤系、「追加」選択中は緑系でボタンを強調。
    - **グレーアウト廃止**: `disabled` 属性を使用すると iOS 等でタップ判定が消える問題に対処するため、CSS クラスによる見た目の制御のみに変更。

- **ボトムバー（カートバー）**
  - **デザイン刷新**: 画面下部に固定された四角いバーに変更（旧来の浮遊する丸ボタン型を廃止）。
  - **エリア分割**:
    - **左側 (合計金額)**: クリックでカート詳細モーダル（削除・数量変更）を表示。
    - **右側 (レジへ進む)**: クリックで注文確認画面へ直行。
  - **表示制御**: メニュー画面 (`#step-menu`) 以外では強制的に非表示になるよう厳格化。

### 4.2 注文フローの堅牢化

- **注文確認画面 (`#step-checkout`) の新設**
  - カートから直接注文するのではなく、確認専用画面を挟むフローに変更。
  - **表示内容**:
    - 受け取り店舗名
    - 注文商品リスト（カード型で見やすくレイアウト、カスタマイズ内容を色分け表示）
    - 合計金額
    - **重要警告**: キャンセル不可、15 分以内受け取りの旨を再掲。
  - **最終確認**: 「注文を確定する」押下時に、ブラウザ標準アラートによる最終確認 (`confirm`) を実施。

### 4.3 技術的修正・バグ対応

- **App Check**: ローカル開発環境 (`localhost`) 用のデバッグトークン設定を追加。
- **Service Worker**: 404 エラーを解消するため、明示的な登録処理を追加。
- **Cloud Functions**: `createOnlineOrder` がカスタマイズ情報を受け取り、サーバーサイドで正しくバリデーション・計算を行うよう改修済み。

---

## 5. 今後のタスク (Next Steps)

1.  **実機テスト**: iOS/Android 実機での表示崩れなどの最終確認。
2.  **`status.html` 結合テスト**: 注文完了後のリダイレクトとステータス表示の連動確認。
3.  **Firebase Storage 運用**: 本番用商品画像のアップロードと Firestore データ (`imageURL`) の更新。
