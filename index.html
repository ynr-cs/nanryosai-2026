<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文化祭モバイルオーダー</title>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px 0;
        background-color: #f4f4f9;
      }
      .container {
        text-align: center;
        background-color: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 500px;
      }
      h1 {
        color: #333;
      }
      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #357ae8;
      }
      #user-info {
        margin-top: 20px;
        font-size: 18px;
        color: #555;
      }
      .hidden {
        display: none;
      }

      /* ▼▼▼ 追加 ▼▼▼ */
      #menu-container {
        margin-top: 30px;
        text-align: left;
      }
      #menu-container h2 {
        text-align: center;
        color: #444;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }
      #menu-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }
      #menu-list li {
        padding: 15px 10px;
        border-bottom: 1px solid #f0f0f0;
      }
      #menu-list li:last-child {
        border-bottom: none;
      }
      .menu-item-name {
        font-weight: bold;
        font-size: 1.1em;
      }
      .menu-item-price {
        float: right;
        color: #e53935;
        font-weight: bold;
      }
      /* ▲▲▲ 追加 ▲▲▲ */
    </style>
  </head>
  <body>
    <div class="container">
      <h1>文化祭モバイルオーダー</h1>

      <!-- ログインボタン -->
      <button id="login-button">Googleでログイン</button>

      <!-- ログイン後情報エリア -->
      <div id="user-info" class="hidden">
        <p id="user-name"></p>
        <button id="logout-button">ログアウト</button>
      </div>

      <!-- ▼▼▼ 追加 ▼▼▼ -->
      <!-- 商品メニュー表示エリア -->
      <div id="menu-container" class="hidden">
        <h2>商品メニュー</h2>
        <ul id="menu-list">
          <!-- ここにJavaScriptで商品リストが挿入される -->
        </ul>
      </div>
      <!-- ▲▲▲ 追加 ▲▲▲ -->
    </div>

    <script type="module">
      // Firebase v9のモジュラースタイルで各機能をインポートする
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        collection, // ▼▼▼ 追加 ▼▼▼
        getDocs, // ▼▼▼ 追加 ▼▼▼
      } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

      // =================================================================
      // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ ここに自分のfirebaseConfigを貼り付け ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.firebasestorage.app",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
        measurementId: "G-1M5G95EXF0",
      };
      // =================================================================

      // ■ 1. Firebaseの初期化
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      // ■ 2. HTML要素の取得
      const loginButton = document.getElementById("login-button");
      const logoutButton = document.getElementById("logout-button");
      const userInfoDiv = document.getElementById("user-info");
      const userNameP = document.getElementById("user-name");
      // ▼▼▼ 追加 ▼▼▼
      const menuContainer = document.getElementById("menu-container");
      const menuList = document.getElementById("menu-list");
      // ▲▲▲ 追加 ▲▲▲

      // ■ 3. ログイン処理
      loginButton.addEventListener("click", () => {
        signInWithPopup(auth, provider)
          .then((result) => {
            console.log("ログイン成功！", result.user);
            saveUserToFirestore(result.user);
          })
          .catch((error) => {
            console.error("ログインエラー:", error);
          });
      });

      // ■ 4. ログアウト処理
      logoutButton.addEventListener("click", () => {
        signOut(auth).catch((error) => {
          console.error("ログアウトエラー:", error);
        });
      });

      // ■ 5. ユーザー情報をFirestoreに保存する関数
      async function saveUserToFirestore(user) {
        const userData = {
          uid: user.uid,
          displayName: user.displayName,
          email: user.email,
          photoURL: user.photoURL,
          lastLogin: new Date(),
        };
        try {
          await setDoc(doc(db, "users", user.uid), userData);
          console.log("Firestoreにユーザー情報を保存しました。");
        } catch (error) {
          console.error("Firestoreへの保存エラー:", error);
        }
      }

      // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ ここから新しい関数を追加 ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
      // ■ 6. Firestoreから商品メニューを取得して表示する関数
      // -----------------------------------------------------------------
      // asyncキーワードは、この関数が非同期処理（完了を待つ必要がある処理）を含むことを示す
      async function displayMenu() {
        console.log("商品メニューの読み込みを開始します...");
        try {
          // getDocsを使って'products'コレクションから全てのドキュメントを取得
          // collection(db, 'コレクション名')で対象のコレクションを指定
          const querySnapshot = await getDocs(collection(db, "products"));

          // 取得したドキュメントをループ処理で一つずつ取り出す
          let htmlContent = ""; // HTML文字列を格納する変数を初期化
          querySnapshot.forEach((doc) => {
            // doc.id でドキュメントID、 doc.data() でドキュメントの中身を取得
            console.log(`${doc.id} => `, doc.data());
            const product = doc.data();

            // 取得したデータを使って、表示するHTML(liタグ)を生成
            // ``(バッククォート)で囲むと、文字列内に変数を埋め込める
            htmlContent += `
                        <li>
                            <span class="menu-item-price">${product.price}円</span>
                            <span class="menu-item-name">${product.name}</span>
                        </li>
                    `;
          });

          // 生成したHTMLをulタグ(menu-list)の中に挿入
          menuList.innerHTML = htmlContent;

          // メニューコンテナを表示状態にする
          menuContainer.classList.remove("hidden");
        } catch (error) {
          // データ取得でエラーが発生した場合の処理
          console.error("メニューデータの取得エラー:", error);
          menuList.innerHTML = "<li>メニューの読み込みに失敗しました。</li>";
        }
      }
      // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

      // ■ 7. ユーザーのログイン状態を監視する (★変更あり★)
      // -----------------------------------------------------------------
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // --- ログインしている場合の処理 ---
          console.log("ログイン状態です:", user);

          // UIをログイン後の状態に更新
          userNameP.textContent = `ようこそ、${user.displayName}さん`;
          userInfoDiv.classList.remove("hidden");
          loginButton.classList.add("hidden");

          // ▼▼▼ 追加 ▼▼▼
          // ログインが確認できたら、メニュー表示関数を呼び出す
          displayMenu();
          // ▲▲▲ 追加 ▲▲▲
        } else {
          // --- ログアウトしている場合の処理 ---
          console.log("ログアウト状態です。");

          // UIをログアウト後の状態（初期状態）に更新
          userNameP.textContent = "";
          userInfoDiv.classList.add("hidden");
          loginButton.classList.remove("hidden");

          // ▼▼▼ 追加 ▼▼▼
          // ログアウトしたら、メニューリストを空にして非表示にする
          menuList.innerHTML = "";
          menuContainer.classList.add("hidden");
          // ▲▲▲ 追加 ▲▲▲
        }
      });
    </script>
  </body>
</html>
