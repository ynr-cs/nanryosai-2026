<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Mobile Order | å—é™µç¥­2026</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- Animate.css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary-color: #333;
        --accent-color: #d32f2f; /* Warning Red */
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --text-main: #212529;
        --text-sub: #6c757d;
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 8px;
        --font-main: "Noto Sans JP", sans-serif;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-main);
        font-family: var(--font-main);
        margin: 0;
        min-height: 100vh;
        -webkit-tap-highlight-color: transparent;
      }

      /* --- Layout Container --- */
      #app-container {
        max-width: 480px;
        margin: 0 auto;
        background: #fff;
        min-height: 100vh;
        position: relative;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
      }

      /* --- Screen Management --- */
      .screen {
        display: none;
        flex: 1;
        flex-direction: column;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
      }
      .screen.active {
        display: flex;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Common UI Components --- */
      .btn-primary-custom {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 50px;
        font-weight: bold;
        width: 100%;
        font-size: 1rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.1s;
      }
      .btn-primary-custom:active:not(:disabled) {
        transform: scale(0.98);
      }
      .btn-primary-custom:disabled {
        background: #ccc;
        box-shadow: none;
      }

      /* --- Step 1: Login --- */
      #step-login {
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .login-hero {
        margin-bottom: 40px;
      }
      .login-logo {
        font-size: 3rem;
        margin-bottom: 10px;
      }

      /* --- Step 2: Terms (Warning) --- */
      .terms-warning-box {
        background: #ffebee;
        border: 2px solid var(--accent-color);
        border-radius: var(--radius-md);
        padding: 20px;
        margin: 20px 0;
      }
      .warning-title {
        color: var(--accent-color);
        font-weight: 900;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }
      .warning-list {
        text-align: left;
        margin-bottom: 0;
        padding-left: 20px;
        font-weight: 700;
        color: #b71c1c;
      }
      .warning-list li {
        margin-bottom: 10px;
      }
      .ban-warning {
        font-size: 1.1em;
        background: #b71c1c;
        color: white;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        font-weight: 900;
      }

      /* --- Step 3: Stores --- */
      .store-card {
        background: white;
        border-radius: var(--radius-md);
        border: 1px solid #eee;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: background 0.2s;
      }
      .store-card:active {
        background: #f8f9fa;
      }
      .store-img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        background: #eee;
      }
      .store-info h3 {
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0;
      }

      /* --- Footer/Bottom Bar (Redesigned) --- */
      .bottom-cart-bar {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 480px; /* Constrain to app width */
        background: #212529; /* Dark background */
        color: white;
        z-index: 1050;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        display: none; /* Hidden by default */
        align-items: center;
        padding-bottom: env(safe-area-inset-bottom); /* Safe area support */
      }

      .cart-info-area {
        flex: 1;
        padding: 15px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .cart-info-area:active {
        background: #343a40;
      }

      .checkout-btn-area {
        padding: 10px 15px 10px 0;
      }

      .btn-checkout-action {
        background: #ffc107; /* Warning color for distinction */
        color: #000;
        font-weight: bold;
        border: none;
        border-radius: 8px; /* Slightly rounded button inside */
        padding: 10px 20px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn-checkout-action:active {
        background: #e0a800;
      }

      /* --- Menu Grid --- */
      .menu-card {
        background: white;
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        transition: transform 0.1s;
      }
      .menu-card:active {
        transform: scale(0.96);
      }
      .menu-img-box {
        position: relative;
        padding-top: 75%; /* 4:3 */
        background: #f8f9fa;
      }
      .menu-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .menu-info {
        padding: 10px;
      }
      .sold-out-badge {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .sold-out-text {
        background: #333;
        color: white;
        padding: 5px 15px;
        font-weight: 900;
        transform: rotate(-10deg);
      }

      /* Customization UI */
      .mode-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .mode-btn {
        flex: 1;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        font-weight: bold;
        color: #aaa;
      }
      .mode-btn.active[data-mode="NO"] {
        border-color: #d32f2f;
        background: #d32f2f;
        color: white;
      }
      .mode-btn.active[data-mode="ADD"] {
        border-color: #2e7d32;
        background: #2e7d32;
        color: white;
      }

      .topping-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
      }
      .topping-btn {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: white;
        font-size: 0.9rem;
        font-weight: 500;
      }
      .topping-btn:active {
        background: #eee;
      }
      .topping-btn.btn-disabled {
        opacity: 0.4;
        background: #f0f0f0;
        color: #ccc;
        border-color: #eee;
        cursor: not-allowed;
      }
      .topping-btn.mod-selected-no {
        background: #ffebee;
        border-color: #d32f2f;
        color: #d32f2f;
        font-weight: bold;
      }
      .topping-btn.mod-selected-add {
        background: #e8f5e9;
        border-color: #2e7d32;
        color: #2e7d32;
        font-weight: bold;
      }

      .active-mods-display {
        min-height: 40px;
        background: #fce4ec; /* Light pink for mods */
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
      }
      .mod-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-right: 5px;
        margin-bottom: 5px;
        font-weight: bold;
        color: white;
      }
      .mod-tag.no {
        background: #d32f2f;
      }
      .mod-tag.add {
        background: #2e7d32;
      }

      /* Cart List */
      .cart-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cart-item-details h5 {
        font-size: 1rem;
        margin: 0;
        font-weight: bold;
      }
      .cart-item-mods {
        font-size: 0.8rem;
        color: #666;
        margin-top: 4px;
      }

      /* --- Modals (Sheet Style) --- */
      .modal.bottom-sheet .modal-dialog {
        margin: 0;
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 480px;
      }
      /* --- Custom Fullscreen Modal for Mobile Width --- */
      .mobile-fullscreen-modal .modal-dialog {
        width: 100%;
        max-width: 480px; /* Match app-container */
        margin: 0 auto;
        height: 100%;
        padding: 0;
      }
      .mobile-fullscreen-modal .modal-content {
        height: 100%;
        border-radius: 0;
        border: none;
      }

      /* Adjust backdrop to be less intrusive for "page transition" feel */
      .modal-backdrop.show {
        opacity: 0.2;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- Loading Overlay -->
      <div
        id="global-loader"
        style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          z-index: 9999;
          display: flex;
          justify-content: center;
          align-items: center;
        "
      >
        <div class="spinner-border text-primary" role="status"></div>
      </div>

      <!-- 1. Login Screen -->
      <!-- 1. Login Screen -->
      <div id="step-login" class="screen">
        <div class="login-hero">
          <div class="login-logo">ğŸ”</div>
          <h1 class="fw-bold">Mobile Order</h1>
          <p class="text-muted">å—é™µç¥­2026</p>
        </div>
        <button id="btn-login" class="btn-primary-custom">
          <i class="bi bi-google me-2"></i> Googleã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </div>

      <!-- 1.5 Notification Screen (New) -->
      <div id="step-notification" class="screen text-center">
        <div class="mt-5 mb-4">
          <div class="mb-3">
            <i class="bi bi-bell-fill text-warning" style="font-size: 4rem"></i>
          </div>
          <h2 class="fw-bold">é€šçŸ¥ã®è¨­å®š</h2>
          <p class="text-muted mt-3">
            å•†å“ã®æº–å‚™ãŒã§ããŸã‚‰<br />
            ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚
          </p>
          <p class="text-muted small">
            æ¬¡ã®ç”»é¢ã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§<br />
            <strong>ã€Œè¨±å¯ã€</strong>ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        <div class="mt-auto pb-4">
          <button id="btn-req-notification" class="btn-primary-custom mb-3">
            é€šçŸ¥ã‚’å—ã‘å–ã‚‹
          </button>
          <button
            class="btn btn-link text-secondary text-decoration-none"
            onclick="skipNotification()"
          >
            é€šçŸ¥ã‚’å—ã‘å–ã‚‰ãªã„
          </button>
        </div>
      </div>

      <!-- 2. Terms Screen -->
      <div id="step-terms" class="screen">
        <div class="text-center mt-4">
          <i
            class="bi bi-shield-exclamation text-danger"
            style="font-size: 3rem"
          ></i>
          <h2 class="fw-bold mt-2">åˆ©ç”¨è¦ç´„ã®ç¢ºèª</h2>
          <p class="text-muted small">ã”æ³¨æ–‡ã®å‰ã«å¿…ãšã”ç¢ºèªãã ã•ã„</p>
        </div>

        <div class="terms-warning-box">
          <div class="warning-title">
            <i class="bi bi-exclamation-triangle-fill"></i> æ³¨æ„äº‹é …
          </div>
          <ul class="warning-list">
            <li>æ³¨æ–‡ç¢ºå®šå¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã§ãã¾ã›ã‚“</li>
            <li>å—ã‘å–ã‚Šã¯ã€Œå‘¼å‡ºã€ã‹ã‚‰15åˆ†ä»¥å†…ã§ã™ï¼ˆçµŒéå¾Œã¯å³å»ƒæ£„ï¼‰</li>
            <li>ãŠé‡‘ã¯è¿”ã£ã¦ãã¾ã›ã‚“</li>
          </ul>
          <div class="ban-warning text-center">
            é•åæ™‚ã¯å…¨é¡å¾´åã®ä¸Š<br />ä»Šå¾Œã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ç§‘å­¦éƒ¨ãŒåˆ¶ä½œã™ã‚‹<br />å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰æ°¸ä¹…BANã—ã¾ã™
          </div>
        </div>

        <div class="mt-auto pb-4">
          <div
            class="form-check mb-3 d-flex justify-content-center gap-2 align-items-center"
          >
            <input
              class="form-check-input"
              type="checkbox"
              id="check-terms"
              style="transform: scale(1.3)"
            />
            <label class="form-check-label fw-bold" for="check-terms"
              >ä¸Šè¨˜å†…å®¹ã‚’ç†è§£ã—ã€åŒæ„ã—ã¾ã™</label
            >
          </div>
          <button id="btn-agree-terms" class="btn-primary-custom" disabled>
            åŒæ„ã—ã¦æ¬¡ã¸
          </button>
        </div>
      </div>

      <!-- 3. Store Select Screen -->
      <div id="step-stores" class="screen">
        <h2 class="fw-bold mb-4">åº—èˆ—ã‚’é¸æŠ</h2>
        <div id="store-list">
          <!-- JS Injected -->
        </div>
      </div>

      <!-- 4. Menu Screen (Grid) -->
      <div id="step-menu" class="screen" style="padding: 0">
        <div
          id="menu-header"
          class="p-3 bg-white sticky-top shadow-sm d-flex align-items-center justify-content-between"
        >
          <h5 class="m-0 fw-bold" id="menu-store-name">Store Name</h5>
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle"
            onclick="backToStores()"
          >
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div
          id="menu-grid"
          class="p-3"
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding-bottom: 100px;
          "
        >
          <!-- JS Injected -->
        </div>
      </div>

      <!-- 5. Checkout Screen -->
      <div id="step-checkout" class="screen">
        <h2 class="fw-bold mb-4">æ³¨æ–‡å†…å®¹ã®ç¢ºèª</h2>

        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body">
            <h6 class="text-muted small">å—ã‘å–ã‚Šåº—èˆ—</h6>
            <h4 class="fw-bold" id="checkout-store-name">Store Name</h4>
          </div>
        </div>

        <div class="card mb-3 shadow-sm border-0">
          <div class="card-header bg-white border-bottom-0 fw-bold">
            æ³¨æ–‡å•†å“
          </div>
          <div class="card-body p-0">
            <div id="checkout-items-list" class="list-group list-group-flush">
              <!-- Injected -->
            </div>
          </div>
        </div>

        <div
          class="d-flex justify-content-between align-items-center mb-4 px-2"
        >
          <span class="fw-bold fs-5">åˆè¨ˆé‡‘é¡</span>
          <span class="fw-bold fs-2 text-danger" id="checkout-total">Â¥0</span>
        </div>

        <div class="alert alert-danger small" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-1"></i>
          <strong>ç¢ºå®šå¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»è¿”é‡‘ã¯ã§ãã¾ã›ã‚“ã€‚</strong><br />
          èª¿ç†å®Œäº†é€šçŸ¥ãŒå±Šã„ã¦ã‹ã‚‰15åˆ†ä»¥å†…ã«å—ã‘å–ã‚Šã«æ¥ã¦ãã ã•ã„ã€‚
        </div>

        <button class="btn-primary-custom mb-3" onclick="finalizeOrder()">
          æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹
        </button>
        <button
          class="btn btn-link text-secondary w-100"
          onclick="backToMenu()"
        >
          ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        </button>
      </div>

      <!-- Bottom Cart Bar (Redesigned) -->
      <div id="bottom-bar" class="bottom-cart-bar d-flex">
        <!-- Left: Cart Info (Open Cart Modal) -->
        <div class="cart-info-area" onclick="openCart()">
          <div class="small text-white-50">åˆè¨ˆé‡‘é¡</div>
          <div class="fw-bold fs-4">
            <span id="bar-total">Â¥0</span>
            <span class="fs-6 fw-normal text-white-50 ms-2" id="bar-count-text"
              >0ç‚¹</span
            >
          </div>
          <div class="small text-warning">
            <i class="bi bi-chevron-up me-1"></i>è©³ç´°ã‚’è¦‹ã‚‹
          </div>
        </div>

        <!-- Right: Checkout Button (Go to Checkout) -->
        <div class="checkout-btn-area">
          <button class="btn-checkout-action" onclick="checkout()">
            ãƒ¬ã‚¸ã¸é€²ã‚€ <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- End App Container -->

    <!-- Placeholder for Modals (Implemented Later) -->
    <!-- Customization Modal (Full Screen) -->
    <div
      class="modal fade mobile-fullscreen-modal"
      id="itemModal"
      tabindex="-1"
      style="z-index: 1060"
    >
      <div class="modal-dialog">
        <div class="modal-content border-0">
          <!-- Header -->
          <div class="modal-header border-0 shadow-sm" style="background: #fff">
            <button
              type="button"
              class="btn btn-link text-dark p-0 me-3"
              data-bs-dismiss="modal"
              style="font-size: 1.5rem"
            >
              <i class="bi bi-chevron-left"></i>
            </button>
            <h5
              class="modal-title fw-bold flex-grow-1 text-center pe-4"
              id="modal-item-name"
            >
              å•†å“å
            </h5>
          </div>

          <!-- Body -->
          <div
            class="modal-body p-0"
            style="background: #f8f9fa; padding-bottom: 120px"
          >
            <!-- Product Image Area -->
            <div class="bg-white text-center py-4 mb-3 shadow-sm">
              <img
                id="modal-item-img"
                src=""
                style="max-width: 60%; max-height: 250px; object-fit: contain"
              />
            </div>

            <!-- Description Area (Simple) -->
            <div class="px-3 mb-4">
              <p class="text-muted small" id="modal-item-desc">
                æ³¨æ–‡å¾Œã®èª¿ç†ã¨ãªã‚Šã¾ã™ã€‚<br />
                â€»ç”»åƒã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
              </p>
            </div>

            <!-- Customization Section -->
            <div class="px-3">
              <div
                id="customization-area"
                class="bg-white p-3 rounded-3 shadow-sm mb-3"
              >
                <!-- Header (Collapsible Trigger) -->
                <div
                  class="d-flex align-items-center justify-content-between"
                  data-bs-toggle="collapse"
                  data-bs-target="#customization-collapse"
                  aria-expanded="false"
                  aria-controls="customization-collapse"
                  style="cursor: pointer"
                >
                  <div class="d-flex align-items-center">
                    <i class="bi bi-gear-fill me-2 text-primary"></i>
                    <span class="fw-bold">ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</span>
                  </div>
                  <i class="bi bi-chevron-down text-muted"></i>
                </div>

                <!-- Collapsible Content -->
                <div class="collapse mt-3" id="customization-collapse">
                  <div class="mode-toggle mb-3">
                    <button
                      class="mode-btn w-100 py-2"
                      data-mode="NO"
                      onclick="setMode('NO')"
                    >
                      <i class="bi bi-dash-circle me-1"></i> æŠœã
                    </button>
                    <button
                      class="mode-btn w-100 py-2"
                      data-mode="ADD"
                      onclick="setMode('ADD')"
                    >
                      <i class="bi bi-plus-circle me-1"></i> è¿½åŠ 
                    </button>
                  </div>

                  <p class="text-muted small mb-2 ms-1">
                    <i class="bi bi-info-circle me-1"></i
                    >å…ˆã«ã€ŒæŠœãã€ã‹ã€Œè¿½åŠ ã€ã‚’é¸ã‚“ã§ãã ã•ã„
                  </p>

                  <div class="topping-list" id="topping-list">
                    <!-- Injected Buttons -->
                  </div>

                  <div
                    class="active-mods-display mt-3"
                    id="active-mods-display"
                    style="display: none"
                  >
                    <small class="text-muted d-block mb-1">é¸æŠä¸­ã®å¤‰æ›´:</small>
                    <div id="active-mods-list"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Spacer for Fixed Footer -->
            <div style="height: 100px"></div>
          </div>

          <!-- Footer (Fixed Bottom Actions) -->
          <div
            class="modal-footer border-top bg-white d-block p-3 fixed-bottom"
            style="
              position: sticky;
              bottom: 0;
              padding-bottom: max(1rem, env(safe-area-inset-bottom));
            "
          >
            <div class="d-flex justify-content-between align-items-end mb-2">
              <div>
                <span class="fs-2 fw-bold" id="modal-item-price">Â¥0</span>
              </div>

              <!-- Quantity Selector -->
              <div
                class="d-flex align-items-center bg-light rounded-pill px-2 py-1 border"
              >
                <button
                  class="btn btn-sm text-secondary"
                  onclick="adjustQty(-1)"
                  style="font-size: 1.2rem; width: 30px"
                >
                  -
                </button>
                <span class="mx-3 fw-bold fs-5" id="modal-item-qty">1</span>
                <button
                  class="btn btn-sm text-primary"
                  onclick="adjustQty(1)"
                  style="font-size: 1.2rem; width: 30px"
                >
                  +
                </button>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <!-- Back Button (Optional, maybe not needed if header has back) -> Let's match image style with mainly Cart Button -->
              <button
                class="btn btn-warning w-100 py-3 rounded-pill fw-bold text-dark shadow-sm"
                onclick="commitAddToCart()"
              >
                ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Modal -->
    <div class="modal fade bottom-sheet" id="cartModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">ã‚«ãƒ¼ãƒˆ</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-0">
            <div id="cart-list">
              <!-- Cart Items -->
            </div>
            <div
              class="p-3 bg-light d-flex justify-content-between align-items-center"
            >
              <span class="fw-bold">åˆè¨ˆ</span>
              <span class="display-6 fw-bold text-danger" id="cart-total-modal"
                >Â¥0</span
              >
            </div>
          </div>
          <div class="modal-footer d-flex gap-2">
            <button
              class="btn btn-outline-secondary flex-fill py-3 rounded-pill fw-bold"
              onclick="clearCart()"
            >
              å…¨å‰Šé™¤
            </button>
            <button
              class="btn btn-primary flex-fill py-3 rounded-pill fw-bold shadow"
              onclick="checkout()"
            >
              æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        setDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import {
        getMessaging,
        getToken,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";
      import {
        getStorage,
        ref as sRef,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.firebasestorage.app",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
      };
      const VAPID_KEY =
        "BI-HfOk34KQVIoJK_8KnKplz3l31I9VLWOJKF7mHBARF-XmgVjpRSyVoSfSnoVZDS7orz-OO8yq-S32STZU30Po";

      const app = initializeApp(firebaseConfig);

      // Initialize App Check
      import {
        initializeAppCheck,
        ReCaptchaEnterpriseProvider,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app-check.js";

      // Allow App Check debug token for localhost
      if (
        location.hostname === "localhost" ||
        location.hostname === "127.0.0.1"
      ) {
        self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
      }

      const appCheck = initializeAppCheck(app, {
        provider: new ReCaptchaEnterpriseProvider(
          "6LdVI4sqAAAAABsFgjK80A2MAiCg7X9K7uJ-gYQ6"
        ),
        isTokenAutoRefreshEnabled: true,
      });

      const auth = getAuth(app);
      const db = getFirestore(app);
      const messaging = getMessaging(app);
      const storage = getStorage(app);
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-functions.js";
      import {
        writeBatch,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      const functions = getFunctions(app, "asia-northeast1");

      // --- State ---
      let currentUser = null;
      let currentStoreId = null;
      let products = [];
      let cart = [];

      // Editing State
      let selectingProduct = null;
      let selectingQty = 1;
      let currentMode = null;
      let currentMods = [];

      // --- Modals --- (Bootstrap)
      let itemModal, cartModal;

      // --- DOM Elements ---
      const loader = document.getElementById("global-loader");

      // --- Initialization ---
      function init() {
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          if (user) {
            // Logged in
            checkFlow();
          } else {
            // Not logged in
            showScreen("step-login");
            loader.style.display = "none";
          }
        });
      }

      // --- Flow Control ---
      async function checkFlow() {
        // Notification Check
        if (Notification.permission === "default") {
          showScreen("step-notification");
        } else {
          // Already granted or denied, proceed to Terms
          if (Notification.permission === "granted") {
            saveToken(); // Ensure token is up to date
          }
          showScreen("step-terms");
        }
        loader.style.display = "none";
      }

      window.skipNotification = () => {
        showScreen("step-terms");
      };

      // --- Action Handlers ---
      document.getElementById("btn-login").onclick = async () => {
        try {
          await signInWithPopup(auth, new GoogleAuthProvider());
        } catch (e) {
          alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
      };

      document.getElementById("btn-req-notification").onclick = async () => {
        try {
          const p = await Notification.requestPermission();
          if (p === "granted") {
            await saveToken();
          }
        } catch (e) {
          console.warn(e);
        }
        showScreen("step-terms");
      };

      document.getElementById("check-terms").onchange = (e) => {
        document.getElementById("btn-agree-terms").disabled = !e.target.checked;
      };

      document.getElementById("btn-agree-terms").onclick = async () => {
        loader.style.display = "flex";
        // Proceed to Store Select
        await loadStores();
        showScreen("step-stores");
        loader.style.display = "none";
      };

      async function saveToken() {
        try {
          // æ˜ç¤ºçš„ã«Service Workerã‚’ç™»éŒ² (ãƒ­ãƒ¼ã‚«ãƒ«/æœ¬ç•ªã®ä¸¡ãƒ‘ã‚¹ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ç›¸å¯¾ãƒ‘ã‚¹æŒ‡å®š)
          // pos/mobile-order.html ã‹ã‚‰è¦‹ã¦åŒã˜éšå±¤ã«ã‚ã‚‹ sw ã‚’æŒ‡ã™
          const swReg = await navigator.serviceWorker.register(
            "./firebase-messaging-sw.js"
          );

          const token = await getToken(messaging, {
            vapidKey: VAPID_KEY,
            serviceWorkerRegistration: swReg,
          });

          if (token && currentUser) {
            await setDoc(
              doc(db, "users", currentUser.uid),
              {
                fcmToken: token,
                notificationEnabled: true,
                lastLogin: serverTimestamp(),
              },
              { merge: true }
            );
          }
        } catch (e) {
          console.warn("Token save failed", e);
        }
      }

      async function loadStores() {
        const list = document.getElementById("store-list");
        list.innerHTML = "";
        try {
          const snap = await getDocs(collection(db, "stores"));

          if (snap.empty) {
            list.innerHTML = "<p>åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
            return;
          }

          snap.forEach((d) => {
            const data = d.data();
            // ç”»åƒå–å¾— (Storageå„ªå…ˆ)
            // ä»Šå›ã¯ç°¡æ˜“çš„ã« ../images/{id}.png ã‚’ä½¿ç”¨
            const imgSrc = `../images/${d.id}.png`;

            const el = document.createElement("div");
            el.className = "store-card animate__animated animate__fadeInUp";
            el.innerHTML = `
                    <img src="${imgSrc}" class="str-img" onerror="this.onerror=null;this.src='../images/noimage.png'">
                    <div class="store-info">
                       <h3>${data.name}</h3>
                       <small class="text-muted">${data.teamName || ""}</small>
                    </div>
                 `;
            el.onclick = () => selectStore(d.id, data.name);
            list.appendChild(el);
          });
        } catch (e) {
          list.innerHTML = `<p class="text-danger">èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</p>`;
          console.error(e);
        }
      }

      window.selectStore = (storeId, storeName) => {
        currentStoreId = storeId;
        document.getElementById("menu-store-name").textContent = storeName;
        showScreen("step-menu");
        loadMenu(storeId);
      };

      window.backToStores = () => {
        currentStoreId = null;
        showScreen("step-stores");
        document.getElementById("bottom-bar").style.display = "none";
      };

      function showScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(id).classList.add("active");

        // Force hide bottom bar if not menu (Safety check)
        const bar = document.getElementById("bottom-bar");
        if (id !== "step-menu") {
          bar.style.display = "none";
        }

        window.scrollTo(0, 0);
      }

      // --- Image Helper ---
      async function setProductImage(imgEl, product) {
        // Reset to placeholder or clear
        imgEl.src = "../images/noimage.png";

        // Priority: imageURL (Firestore field) -> Fallback to noimage
        // Note: User specified "imageURL" but we check "imageUrl" too just in case
        const pathOrUrl = product.imageURL || product.imageUrl;

        if (!pathOrUrl) {
          // No image defined, keep placeholder
          return;
        }

        if (pathOrUrl.startsWith("http") || pathOrUrl.startsWith("data:")) {
          imgEl.src = pathOrUrl;
        } else {
          // Assume Firebase Storage path
          try {
            const url = await getDownloadURL(sRef(storage, pathOrUrl));
            imgEl.src = url;
          } catch (e) {
            console.warn("Storage image load failed:", pathOrUrl, e);
            imgEl.src = "../images/noimage.png";
          }
        }

        imgEl.onerror = () => {
          imgEl.src = "../images/noimage.png";
        };
      }

      // --- Menu Logic ---
      window.loadMenu = async (storeId) => {
        const grid = document.getElementById("menu-grid");
        grid.innerHTML = '<div class="spinner-border text-primary"></div>';
        products = [];

        try {
          const q = query(
            collection(db, "items"),
            where("storeId", "==", storeId)
          );
          const snap = await getDocs(q);
          grid.innerHTML = "";

          snap.forEach((d) => {
            const p = d.data();
            p.id = d.id;
            products.push(p);

            const isSoldOut = p.isAvailable === false;
            const el = document.createElement("div");
            el.className = "menu-card animate__animated animate__fadeIn";
            if (isSoldOut) el.style.opacity = "0.7";

            el.innerHTML = `
                  <div class="menu-img-box">
                     ${
                       isSoldOut
                         ? '<div class="sold-out-badge"><span class="sold-out-text">SOLD OUT</span></div>'
                         : ""
                     }
                     <img class="menu-img" id="img-${p.id}">
                  </div>
                  <div class="menu-info">
                     <div class="fw-bold text-truncate">${p.name}</div>
                     <div class="fw-bold mt-1">Â¥${p.price}</div>
                  </div>
               `;

            // Set Image Async
            const imgEl = el.querySelector(".menu-img");
            setProductImage(imgEl, p);

            el.onclick = () => {
              if (!isSoldOut) openItemModal(p);
            };
            grid.appendChild(el);
          });

          if (products.length === 0) grid.innerHTML = "<p>å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>";

          // Show bottom bar if cart has items
          updateBottomBar();
        } catch (e) {
          console.error(e);
          grid.innerHTML = "<p>èª­ã¿è¾¼ã¿å¤±æ•—</p>";
        }
      };

      // --- Item Detail & Customization ---
      window.openItemModal = (product) => {
        selectingProduct = product;
        selectingQty = 1;
        currentMode = null;
        currentMods = [];

        document.getElementById("modal-item-name").textContent = product.name;
        document.getElementById(
          "modal-item-price"
        ).textContent = `Â¥${product.price}`;
        document.getElementById("modal-item-qty").textContent = selectingQty;

        // Set Image
        const imgEl = document.getElementById("modal-item-img");
        setProductImage(imgEl, product);

        // Setup Customization
        renderCustomizationUI();

        // Reset Collapse state
        const collapseEl = document.getElementById("customization-collapse");
        if (collapseEl) {
          collapseEl.classList.remove("show");
        }

        if (!itemModal)
          itemModal = new bootstrap.Modal(document.getElementById("itemModal"));
        itemModal.show();
      };

      function renderCustomizationUI() {
        const area = document.getElementById("customization-area");
        const list = document.getElementById("topping-list");
        // Show area if allowedToppings exist
        const allowed = selectingProduct.allowedToppings || [];

        if (allowed.length === 0) {
          area.style.display = "none";
        } else {
          area.style.display = "block";
          // Buttons
          list.innerHTML = "";
          allowed.forEach((t) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "topping-btn";
            btn.dataset.target = t; // Add dataset for easier selection
            btn.textContent = t;
            btn.onclick = () => toggleMod(t);
            list.appendChild(btn);
          });
          updateModeBtns();
          renderActiveMods();
          updateToppingBtnStyles(); // Initialize styles
        }

        // Clear previous selection display
        document.getElementById("active-mods-display").style.display = "none";
      }

      window.setMode = (mode) => {
        currentMode = currentMode === mode ? null : mode;
        updateModeBtns();
      };

      function updateToppingBtnStyles() {
        const toppingBtns = document.querySelectorAll(
          "#topping-list .topping-btn"
        );
        toppingBtns.forEach((btn) => {
          const target = btn.dataset.target;
          const mod = currentMods.find((m) => m.target === target);

          btn.classList.remove("mod-selected-no", "mod-selected-add");
          if (mod) {
            if (mod.mode === "NO") btn.classList.add("mod-selected-no");
            if (mod.mode === "ADD") btn.classList.add("mod-selected-add");
          }
        });
      }

      function updateModeBtns() {
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          if (btn.dataset.mode === currentMode) btn.classList.add("active");
          else btn.classList.remove("active");
        });

        // Ensure buttons are enabled (removed btn-disabled styling to avoid confusion)
        const toppingBtns = document.querySelectorAll(
          "#topping-list .topping-btn"
        );
        toppingBtns.forEach((btn) => {
          btn.disabled = false;
          btn.classList.remove("btn-disabled");
        });
      }

      function toggleMod(target) {
        if (!currentMode) {
          // Provide visual feedback instead of alert
          const modeContainer = document.querySelector(".mode-toggle");
          modeContainer.classList.remove(
            "animate__animated",
            "animate__headShake"
          );
          void modeContainer.offsetWidth; // Force reflow
          modeContainer.classList.add(
            "animate__animated",
            "animate__headShake"
          );
          return;
        }

        const existingIdx = currentMods.findIndex((m) => m.target === target);

        if (existingIdx >= 0) {
          const existing = currentMods[existingIdx];
          // If same mode, toggle OFF (remove)
          if (existing.mode === currentMode) {
            currentMods.splice(existingIdx, 1);
          } else {
            // If different mode, Overwrite
            existing.mode = currentMode;
          }
        } else {
          // New
          currentMods.push({ mode: currentMode, target: target });
        }
        renderActiveMods();
        updateToppingBtnStyles();
      }

      function renderActiveMods() {
        const div = document.getElementById("active-mods-list");
        div.innerHTML = "";
        currentMods.forEach((m) => {
          const span = document.createElement("span");
          span.className = `mod-tag ${m.mode.toLowerCase()}`;
          span.textContent = `${m.mode} ${m.target}`;
          div.appendChild(span);
        });
      }

      window.adjustQty = (delta) => {
        selectingQty += delta;
        if (selectingQty < 1) selectingQty = 1;
        document.getElementById("modal-item-qty").textContent = selectingQty;
      };

      window.commitAddToCart = () => {
        // Add to Cart
        const sortedNewMods = [...currentMods].sort((a, b) =>
          (a.mode + a.target).localeCompare(b.mode + b.target)
        );
        const newModsStr = JSON.stringify(sortedNewMods);

        const existing = cart.find((c) => {
          if (c.productId !== selectingProduct.id) return false;
          const cMods = [...c.customizations].sort((a, b) =>
            (a.mode + a.target).localeCompare(b.mode + b.target)
          );
          return JSON.stringify(cMods) === newModsStr;
        });

        if (existing) {
          existing.quantity += selectingQty;
        } else {
          cart.push({
            uniqueId: Date.now() + Math.random(),
            productId: selectingProduct.id,
            name: selectingProduct.name,
            price: selectingProduct.price,
            quantity: selectingQty,
            customizations: sortedNewMods,
            allowedToppings: selectingProduct.allowedToppings || [],
          });
        }

        updateBottomBar();
        itemModal.hide();
      };

      // --- Cart Logic ---
      window.openCart = () => {
        renderCartList();
        if (!cartModal)
          cartModal = new bootstrap.Modal(document.getElementById("cartModal"));
        cartModal.show();
      };

      function renderCartList() {
        const list = document.getElementById("cart-list");
        list.innerHTML = "";
        let total = 0;

        cart.forEach((c, idx) => {
          total += c.price * c.quantity;
          const el = document.createElement("div");
          el.className = "cart-item";

          let modsHtml = "";
          c.customizations.forEach((m) => {
            modsHtml += `<span class="badge bg-secondary me-1" style="font-size:0.7rem">${m.mode} ${m.target}</span>`;
          });

          el.innerHTML = `
               <div class="cart-item-details">
                  <h5>${c.name}</h5>
                  <div class="text-muted">Â¥${c.price} x ${c.quantity}</div>
                  <div class="cart-item-mods">${modsHtml}</div>
               </div>
               <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${idx})">å‰Šé™¤</button>
            `;
          list.appendChild(el);
        });

        document.getElementById("cart-total-modal").textContent = `Â¥${total}`;
        if (cart.length === 0)
          list.innerHTML = "<p class='p-3 text-center'>ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</p>";
      }

      window.removeFromCart = (idx) => {
        cart.splice(idx, 1);
        renderCartList();
        updateBottomBar();
        if (cart.length === 0) cartModal.hide();
      };

      window.clearCart = () => {
        if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          cart = [];
          renderCartList();
          updateBottomBar();
          cartModal.hide();
        }
      };

      function updateBottomBar() {
        const bar = document.getElementById("bottom-bar");
        // Strictly check if we are on the menu screen
        const menuScreen = document.getElementById("step-menu");
        // Note: checking classList.contains("active") might be flaky if called during transition
        // So we also check if the active screen is indeed step-menu
        const activeScreen = document.querySelector(".screen.active");

        if (!activeScreen || activeScreen.id !== "step-menu") {
          bar.style.display = "none";
          return;
        }

        if (cart.length === 0) {
          bar.style.display = "none";
        } else {
          bar.style.display = "flex";
          let total = 0;
          let count = 0;
          cart.forEach((c) => {
            total += c.price * c.quantity;
            count += c.quantity;
          });
          document.getElementById("bar-total").textContent = `Â¥${total}`;
          const countEl = document.getElementById("bar-count-text");
          if (countEl) countEl.textContent = `${count}ç‚¹`;
        }
      }

      // --- Checkout ---
      window.backToMenu = () => {
        showScreen("step-menu");
        // Restore bottom bar
        updateBottomBar();
      };

      window.checkout = () => {
        // Close Cart Modal
        if (cartModal) cartModal.hide();

        // Populate Checkout Screen
        const storeName =
          document.getElementById("menu-store-name").textContent;
        document.getElementById("checkout-store-name").textContent = storeName;

        const list = document.getElementById("checkout-items-list");
        list.innerHTML = "";
        let total = 0;

        cart.forEach((c) => {
          total += c.price * c.quantity;
          let modsHtml = "";
          c.customizations.forEach((m) => {
            // Color code the customization tags
            const colorClass =
              m.mode === "NO"
                ? "text-danger border-danger"
                : "text-success border-success";
            modsHtml += `<span class="badge bg-white border ${colorClass} me-1 mb-1" style="font-size:0.8rem">${m.mode} ${m.target}</span>`;
          });

          const div = document.createElement("div");
          div.className =
            "list-group-item p-3 border-0 border-bottom d-flex justify-content-between align-items-start";
          div.innerHTML = `
                <div class="me-3" style="flex: 1;">
                  <div class="fw-bold mb-2" style="font-size: 1.15rem;">${
                    c.name
                  }</div>
                  <div class="mb-2 d-flex flex-wrap">${
                    modsHtml || '<span class="text-muted small">å¤‰æ›´ãªã—</span>'
                  }</div>
                  <div class="text-muted small d-flex align-items-center">
                    <span class="me-2">å˜ä¾¡ Â¥${c.price}</span>
                    <span class="badge bg-light text-dark border">x${
                      c.quantity
                    }</span>
                  </div>
                </div>
                <div class="fw-bold fs-5 text-nowrap mt-1">Â¥${
                  c.price * c.quantity
                }</div>
             `;
          list.appendChild(div);
        });

        document.getElementById("checkout-total").textContent = `Â¥${total}`;

        // Hide bottom bar for this screen
        document.getElementById("bottom-bar").style.display = "none";
        showScreen("step-checkout");
      };

      window.finalizeOrder = async () => {
        // Double Check (Browser Alert)
        if (!confirm("æœ¬å½“ã«æ³¨æ–‡ã‚’ç¢ºå®šã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

        loader.style.display = "flex";
        try {
          // 1. Sync Cart again just to be sure
          const cartRef = collection(db, `users/${currentUser.uid}/cart`);
          const batch = writeBatch(db);

          const oldSnap = await getDocs(cartRef);
          oldSnap.forEach((d) => batch.delete(d.ref));

          cart.forEach((c) => {
            const ref = doc(cartRef);
            batch.set(ref, {
              productId: c.productId,
              quantity: c.quantity,
              customizations: c.customizations,
              updatedAt: serverTimestamp(),
            });
          });
          await batch.commit();

          // 2. Call Function
          const createOnlineOrder = httpsCallable(
            functions,
            "createOnlineOrder"
          );
          const result = await createOnlineOrder({ storeId: currentStoreId });
          if (!result.data.success)
            throw new Error(result.data.error || "Order Failed");

          // 3. Redirect
          window.location.href = `status.html?orderId=${result.data.orderId}`;
        } catch (e) {
          console.error(e);
          alert("æ³¨æ–‡å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
          loader.style.display = "none";
        }
      };

      init();
    </script>
  </body>
</html>
