<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—èˆ—ç®¡ç†ãƒãƒ¼ã‚¿ãƒ« | å—é™µç¥­2026</title>
    <style>
        /* ============================
           åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
           ============================ */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f6f9;
            margin: 0; padding: 0; color: #333;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        h1, h2, h3 { text-align: center; color: #2c3e50; }
        
        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input[type="text"], input[type="password"], input[type="number"], textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc;
            border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }
        textarea { resize: vertical; height: 80px; font-family: inherit; }

        /* ãƒœã‚¿ãƒ³ */
        button {
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            transition: opacity 0.2s; color: white; margin-bottom: 10px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }

        .btn-primary { background-color: #007bff; }
        .btn-google { background-color: #db4437; }
        .btn-add { background-color: #6610f2; }
        .btn-update { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }

        /* ãƒˆãƒƒãƒ”ãƒ³ã‚°å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .topping-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .topping-row input { flex: 1; }
        .btn-sm-delete { width: auto; padding: 0 15px; background: #dc3545; color: white; margin: 0; }
        .btn-sm-add { width: auto; background: #17a2b8; display: inline-block; padding: 8px 16px; font-size: 0.9rem; color: white; border:none; border-radius:4px; cursor:pointer;}

        /* å•†å“ãƒªã‚¹ãƒˆ */
        .item-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px; border-bottom: 1px solid #eee; gap: 15px;
        }
        .item-row:last-child { border-bottom: none; }

        .item-img {
            width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #eee; flex-shrink: 0;
        }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-desc { font-size: 0.85rem; color: #666; margin: 4px 0; white-space: pre-wrap; }
        .badge-recommend {
            background: #ffc107; color: #333; font-size: 0.7rem;
            padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle;
        }
        .item-actions {
            display: flex; flex-direction: column; gap: 8px; width: 100px; flex-shrink: 0;
        }
        .action-btn { font-size: 0.8rem; padding: 6px; margin: 0; }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .view-section { display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ */
        .login-card { max-width: 400px; width: 100%; text-align: center; }
        .auth-info { background: #eee; padding: 5px; font-size: 0.8rem; margin-bottom: 10px; border-radius: 4px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (ç·¨é›†ç”¨) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* ãƒªãƒ³ã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .menu-link { 
            text-decoration: none; background: white; border: 1px solid #ddd; 
            color: #333; padding: 15px; text-align: center; border-radius: 8px; font-weight: bold; display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .menu-link:hover { background: #f8f9fa; border-color: #007bff; color: #007bff; }
    </style>
</head>
<body>

    <!-- 1. Googleèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="google-auth-section" class="view-section" style="display: flex;">
        <div class="card login-card">
            <h2>ç®¡ç†è€…èªè¨¼</h2>
            <p style="color:#666; font-size:0.9rem;">
                DBæ¥ç¶šè¨±å¯ã®ãŸã‚ã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚<br>
                (ã©ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚‚æ§‹ã„ã¾ã›ã‚“)
            </p>
            <button id="googleLoginBtn" class="btn-google">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="googleAuthError" style="color:red; font-size:0.9rem;"></div>
        </div>
    </div>

    <!-- 2. åº—èˆ—ãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="store-login-section" class="view-section">
        <div class="card login-card">
            <div class="auth-info">èªè¨¼æ¸ˆã¿: <span id="userEmailDisplay"></span></div>
            <h2>åº—èˆ—ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div class="form-group">
                <input type="text" id="loginId" placeholder="åº—èˆ—ID (ä¾‹: class101)">
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            </div>
            <button id="storeLoginBtn" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="storeLoginError" style="color:red; margin-top:10px; font-size:0.9rem;"></div>
        </div>
    </div>

    <!-- 3. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="dashboard-section" style="display: none; padding-top: 20px;">
        <div class="container">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card" style="text-align:center;">
                <h1 id="displayStoreName" style="margin:0; color:#007bff;">åº—èˆ—å</h1>
                <p style="color:#666; margin:5px 0;"><span id="displayTeamName"></span> (ID: <span id="displayStoreId"></span>)</p>
            </div>

            <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ -->
            <div class="card">
                <h3 style="margin-top:0;">æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
                <div class="menu-grid">
                    <a href="#" id="linkPos" class="menu-link">ğŸ“± POSãƒ¬ã‚¸</a>
                    <a href="#" id="linkKitchen" class="menu-link">ğŸ³ å¨æˆ¿</a>
                    <a href="#" id="linkPresenter" class="menu-link">ğŸ æä¾›å£</a>
                    <a href="#" id="linkMonitor" class="menu-link">ğŸ“º ãƒ¢ãƒ‹ã‚¿ãƒ¼</a>
                    <a href="#" id="linkReport" class="menu-link">ğŸ“Š å£²ä¸Š</a>
                </div>
            </div>

            <!-- å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <h3 style="margin-top:0;">æ–°è¦å•†å“ã®è¿½åŠ </h3>
                <div class="form-group">
                    <label>å•†å“å *</label>
                    <input type="text" id="addName" placeholder="ä¾‹: ç„¼ããã°">
                </div>
                <div class="form-group">
                    <label>ä¾¡æ ¼ (å††) *</label>
                    <input type="number" id="addPrice" placeholder="ä¾‹: 300">
                </div>
                <div class="form-group">
                    <label>èª¬æ˜æ–‡</label>
                    <textarea id="addDesc" placeholder="å•†å“ã®ç‰¹å¾´ãªã©ã‚’å…¥åŠ›"></textarea>
                </div>
                <div class="form-group">
                    <label>å•†å“ç”»åƒ</label>
                    <input type="file" id="addImage" accept="image/*">
                </div>
                <div class="form-group">
                    <label>ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
                    <div id="addToppingsContainer">
                        <!-- ã“ã“ã«å…¥åŠ›æ¬„ãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                    <button type="button" class="btn-sm-add" onclick="window.addToppingInput('addToppingsContainer')">ï¼‹ ãƒˆãƒƒãƒ”ãƒ³ã‚°æ ã‚’è¿½åŠ </button>
                </div>
                <div class="form-group" style="display:flex; align-items:center;">
                    <input type="checkbox" id="addRecommended" style="width:auto; margin-right:8px;">
                    <label for="addRecommended" style="margin:0; cursor:pointer;">ãŠã™ã™ã‚å•†å“ã¨ã—ã¦å¼·èª¿ã™ã‚‹</label>
                </div>
                <button id="addItemBtn" class="btn-add">å•†å“ã‚’ç™»éŒ²ã™ã‚‹</button>
            </div>

            <!-- å•†å“ãƒªã‚¹ãƒˆ -->
            <h3 style="text-align:left; border-left: 5px solid #007bff; padding-left:10px;">å•†å“ä¸€è¦§</h3>
            <div class="card" id="itemsContainer" style="padding:0; overflow:hidden;">
                <div style="text-align:center; padding:20px; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- 4. ç·¨é›†ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">å•†å“ã‚’ç·¨é›†</h3>
            <input type="hidden" id="editDocId">
            
            <div class="form-group">
                <label>å•†å“å</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>ä¾¡æ ¼</label>
                <input type="number" id="editPrice">
            </div>
            <div class="form-group">
                <label>èª¬æ˜æ–‡</label>
                <textarea id="editDesc"></textarea>
            </div>
            <div class="form-group">
                <label>ç”»åƒã‚’å¤‰æ›´</label>
                <input type="file" id="editImage" accept="image/*">
                <div id="currentImagePreview" style="margin-top:5px; font-size:0.8rem; color:#666;"></div>
            </div>
            <div class="form-group">
                <label>ãƒˆãƒƒãƒ”ãƒ³ã‚°</label>
                <div id="editToppingsContainer"></div>
                <button type="button" class="btn-sm-add" onclick="window.addToppingInput('editToppingsContainer')">ï¼‹ è¿½åŠ </button>
            </div>
            <div class="form-group" style="display:flex; align-items:center;">
                <input type="checkbox" id="editRecommended" style="width:auto; margin-right:8px;">
                <label for="editRecommended" style="margin:0; cursor:pointer;">ãŠã™ã™ã‚</label>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="updateItemBtn" class="btn-update">æ›´æ–°ä¿å­˜</button>
                <button onclick="document.getElementById('editModal').style.display='none'" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (v9 Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, onSnapshot, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // ==========================================
        //  è¨­å®š: æ­£ã—ã„ãƒã‚±ãƒƒãƒˆåã«ä¿®æ­£æ¸ˆã¿
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do", 
            authDomain: "nanryosai-2026-a4091.firebaseapp.com",
            projectId: "nanryosai-2026-a4091",
            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¿…é ˆ
            storageBucket: "nanryosai-2026-a4091.firebasestorage.app", 
            messagingSenderId: "360316480856",
            appId: "1:360316480856:web:1234567890abcdef" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ç¾åœ¨ã®çŠ¶æ…‹ä¿æŒ
        let currentStoreId = null;
        let itemsCache = {}; // ç·¨é›†ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜

        // ==========================================
        //  ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•° (HTMLã®onclickã‹ã‚‰å‘¼ã¶ãŸã‚)
        // ==========================================
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°å…¥åŠ›æ ã‚’è¿½åŠ 
        window.addToppingInput = (containerId, value = "") => {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'topping-row';
            div.innerHTML = `
                <input type="text" class="topping-input" value="${value}" placeholder="ãƒˆãƒƒãƒ”ãƒ³ã‚°å">
                <button type="button" class="btn-sm-delete" onclick="this.parentElement.remove()">å‰Šé™¤</button>
            `;
            container.appendChild(div);
        };

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿ (è²©å£²ä¸­/å£²åˆ‡)
        window.toggleStatus = async (id, newStatus) => {
            try { await updateDoc(doc(db, "items", id), { isAvailable: newStatus }); }
            catch(e) { alert("æ›´æ–°å¤±æ•—: " + e.message); }
        };

        // å•†å“å‰Šé™¤
        window.deleteItem = async (id) => {
            if(!confirm("æœ¬å½“ã«ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(å…ƒã«æˆ»ã›ã¾ã›ã‚“)")) return;
            try { await deleteDoc(doc(db, "items", id)); }
            catch(e) { alert("å‰Šé™¤å¤±æ•—: " + e.message); }
        };

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.setupEditModal = (id) => {
            const item = itemsCache[id];
            if(!item) return;

            document.getElementById('editDocId').value = id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editPrice').value = item.price;
            document.getElementById('editDesc').value = item.description || "";
            document.getElementById('editRecommended').checked = item.isRecommended || false;
            document.getElementById('editImage').value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚»ãƒƒãƒˆ
            
            // ç¾åœ¨ã®ç”»åƒè¡¨ç¤º
            const preview = document.getElementById('currentImagePreview');
            preview.innerHTML = item.imageUrl 
                ? `ç¾åœ¨ã®ç”»åƒ: <a href="${item.imageUrl}" target="_blank" style="color:#007bff;">ç¢ºèªã™ã‚‹</a>` 
                : "ç¾åœ¨ã®ç”»åƒ: ãªã—";

            // ãƒˆãƒƒãƒ”ãƒ³ã‚°ä¸€è¦§ã‚’å±•é–‹
            const container = document.getElementById('editToppingsContainer');
            container.innerHTML = "";
            if(item.allowedToppings) {
                item.allowedToppings.forEach(t => window.addToppingInput('editToppingsContainer', t));
            } else {
                // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒãªã„å ´åˆã§ã‚‚ç©ºæ¬„ã¯å‡ºã•ãªã„ï¼ˆè¿½åŠ ãƒœã‚¿ãƒ³ã§å‡ºã—ã¦ã‚‚ã‚‰ã†ï¼‰
            }

            document.getElementById('editModal').style.display = 'flex';
        };

        // ==========================================
        //  å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        // ==========================================

        // ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°å…¥åŠ›å€¤ã‚’å–å¾—
        function getToppingsFromContainer(containerId) {
            const inputs = document.querySelectorAll(`#${containerId} .topping-input`);
            const list = [];
            inputs.forEach(input => {
                const val = input.value.trim();
                if(val) list.push(val);
            });
            return list;
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        async function uploadImage(file) {
            if (!file) return null;
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ (åº—èˆ—ID/ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—_ãƒ•ã‚¡ã‚¤ãƒ«å)
            const fileName = `product_images/${currentStoreId}/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, fileName);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        }

        // ==========================================
        //  1. èªè¨¼ & ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼
        // ==========================================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Googleèªè¨¼æ¸ˆã¿
                document.getElementById('userEmailDisplay').textContent = user.email;
                document.getElementById('google-auth-section').style.display = 'none';
                document.getElementById('store-login-section').style.display = 'flex';
            } else {
                // æœªèªè¨¼
                document.getElementById('dashboard-section').style.display = 'none';
                document.getElementById('store-login-section').style.display = 'none';
                document.getElementById('google-auth-section').style.display = 'flex';
            }
        });

        // Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            try { 
                await signInWithPopup(auth, new GoogleAuthProvider()); 
            } catch (e) { 
                document.getElementById('googleAuthError').textContent = "èªè¨¼ã‚¨ãƒ©ãƒ¼: " + e.message; 
            }
        });

        // åº—èˆ—ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
        document.getElementById('storeLoginBtn').addEventListener('click', async () => {
            const id = document.getElementById('loginId').value.trim();
            const pass = document.getElementById('password').value.trim();
            if(!id || !pass) return;

            try {
                // Firestoreã‹ã‚‰åº—èˆ—æ¤œç´¢
                const q = query(collection(db, "stores"), where("loginId", "==", id));
                const snap = await getDocs(q);
                
                if(snap.empty) throw new Error("IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                
                const storeDoc = snap.docs[0];
                const data = storeDoc.data();
                
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç…§åˆ
                if(String(data.password) !== String(pass)) throw new Error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");

                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ -> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
                currentStoreId = storeDoc.id;
                initDashboard(storeDoc.id, data);
            } catch(e) {
                document.getElementById('storeLoginError').textContent = e.message;
            }
        });

        // ==========================================
        //  2. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
        // ==========================================
        function initDashboard(storeId, data) {
            document.getElementById('store-login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            
            document.getElementById('displayStoreName').textContent = data.name;
            document.getElementById('displayTeamName').textContent = data.teamName;
            document.getElementById('displayStoreId').textContent = storeId;

            // å„ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯è¨­å®š (storeIdã‚’ä»˜ä¸)
            ['Pos','Kitchen','Presenter','Monitor','Report'].forEach(key => {
                const fileName = key === 'Report' ? 'sales-report.html' : `${key.toLowerCase()}.html`;
                document.getElementById(`link${key}`).href = `${fileName}?storeId=${storeId}`;
            });

            // å•†å“ä¸€è¦§ã®ç›£è¦–é–‹å§‹
            startItemListener(storeId);
        }

        // ==========================================
        //  3. å•†å“ä¸€è¦§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        // ==========================================
        function startItemListener(storeId) {
            const q = query(collection(db, "items"), where("storeId", "==", storeId));
            const container = document.getElementById('itemsContainer');

            onSnapshot(q, (snapshot) => {
                container.innerHTML = "";
                itemsCache = {}; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒªã‚»ãƒƒãƒˆ

                if(snapshot.empty) {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">å•†å“ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const id = docSnap.id;
                    itemsCache[id] = item; // ç·¨é›†ç”¨ã«ä¿å­˜

                    const div = document.createElement('div');
                    div.className = 'item-row';
                    
                    // ç”»åƒè¡¨ç¤º
                    const imgHtml = item.imageUrl 
                        ? `<img src="${item.imageUrl}" class="item-img">` 
                        : `<div class="item-img" style="display:flex;align-items:center;justify-content:center;color:#ccc;font-size:0.7rem;">NO IMAGE</div>`;

                    // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º
                    const toppingTxt = (item.allowedToppings && item.allowedToppings.length) 
                        ? `OP: ${item.allowedToppings.join(', ')}` : "";

                    div.innerHTML = `
                        ${imgHtml}
                        <div class="item-info">
                            <div class="item-name">
                                ${item.name} <span style="font-size:0.9rem; color:#666;">(Â¥${item.price})</span>
                                ${item.isRecommended ? '<span class="badge-recommend">ãŠã™ã™ã‚</span>' : ''}
                            </div>
                            <div class="item-desc">${item.description || ""}</div>
                            <div style="font-size:0.8rem; color:#888; margin-top:2px;">${toppingTxt}</div>
                            <div style="margin-top:6px;">
                                <span style="background:${item.isAvailable?'#d4edda':'#f8d7da'}; color:${item.isAvailable?'#155724':'#721c24'}; padding:3px 10px; border-radius:12px; font-size:0.8rem; font-weight:bold;">
                                    ${item.isAvailable ? 'â— è²©å£²ä¸­' : 'Ã— å£²åˆ‡'}
                                </span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn ${item.isAvailable ? 'btn-secondary' : 'btn-update'}" onclick="window.toggleStatus('${id}', ${!item.isAvailable})">
                                ${item.isAvailable ? 'å£²åˆ‡ã«ã™ã‚‹' : 'è²©å£²å†é–‹'}
                            </button>
                            <button class="action-btn btn-primary" onclick="window.setupEditModal('${id}')">ç·¨é›†</button>
                            <button class="action-btn btn-danger" onclick="window.deleteItem('${id}')">å‰Šé™¤</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // ==========================================
        //  4. å•†å“ç™»éŒ²å‡¦ç†
        // ==========================================
        document.getElementById('addItemBtn').addEventListener('click', async () => {
            const btn = document.getElementById('addItemBtn');
            const name = document.getElementById('addName').value.trim();
            const price = document.getElementById('addPrice').value;
            const desc = document.getElementById('addDesc').value.trim();
            const fileInput = document.getElementById('addImage');
            const isRec = document.getElementById('addRecommended').checked;
            
            if(!name || !price) return alert("å•†å“åã¨ä¾¡æ ¼ã¯å¿…é ˆã§ã™");

            btn.disabled = true;
            btn.textContent = "ç™»éŒ²ä¸­...";

            try {
                let imageUrl = "";
                if(fileInput.files[0]) {
                    imageUrl = await uploadImage(fileInput.files[0]);
                }

                await addDoc(collection(db, "items"), {
                    storeId: currentStoreId,
                    name: name,
                    price: Number(price),
                    description: desc,
                    imageUrl: imageUrl,
                    allowedToppings: getToppingsFromContainer('addToppingsContainer'),
                    isRecommended: isRec,
                    isAvailable: true // åˆæœŸå€¤ã¯è²©å£²ä¸­
                });

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
                document.getElementById('addName').value = "";
                document.getElementById('addPrice').value = "";
                document.getElementById('addDesc').value = "";
                document.getElementById('addImage').value = "";
                document.getElementById('addToppingsContainer').innerHTML = "";
                document.getElementById('addRecommended').checked = false;
                
                alert("å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼");

            } catch(e) {
                alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + e.message);
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.textContent = "å•†å“ã‚’ç™»éŒ²ã™ã‚‹";
            }
        });

        // ==========================================
        //  5. å•†å“æ›´æ–°å‡¦ç†
        // ==========================================
        document.getElementById('updateItemBtn').addEventListener('click', async () => {
            const btn = document.getElementById('updateItemBtn');
            const id = document.getElementById('editDocId').value;
            const name = document.getElementById('editName').value.trim();
            const price = document.getElementById('editPrice').value;
            const desc = document.getElementById('editDesc').value.trim();
            const fileInput = document.getElementById('editImage');
            const isRec = document.getElementById('editRecommended').checked;

            if(!name || !price) return alert("å•†å“åã¨ä¾¡æ ¼ã¯å¿…é ˆã§ã™");

            btn.disabled = true;
            btn.textContent = "æ›´æ–°ä¸­...";

            try {
                const updateData = {
                    name: name,
                    price: Number(price),
                    description: desc,
                    allowedToppings: getToppingsFromContainer('editToppingsContainer'),
                    isRecommended: isRec
                };

                // æ–°ã—ã„ç”»åƒãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                if(fileInput.files[0]) {
                    updateData.imageUrl = await uploadImage(fileInput.files[0]);
                }

                await updateDoc(doc(db, "items", id), updateData);
                
                document.getElementById('editModal').style.display = 'none';
                
            } catch(e) {
                alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "æ›´æ–°ä¿å­˜";
            }
        });

    </script>
</body>
</html>